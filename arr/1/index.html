<!DOCTYPE html>

<html>
<head>
<title>ARR-1: Ave Media - Wapaganda Project Docs</title>
<style>
      /* load heading font */
      @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400');
      @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@400');
      @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@700');
      @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@700');

      /* load body font */
      @import url('https://fonts.googleapis.com/css2?family=Noto Sans:wght@400');
      @import url('https://fonts.googleapis.com/css2?family=Noto Sans:ital,wght@400');
      @import url('https://fonts.googleapis.com/css2?family=Noto Sans:wght@700');
      @import url('https://fonts.googleapis.com/css2?family=Noto Sans:ital,wght@700');

      /* load mono font */
      @import url('https://fonts.googleapis.com/css2?family=JetBrains Mono:wght@400');
      @import url('https://fonts.googleapis.com/css2?family=JetBrains Mono:ital,wght@400');
      @import url('https://fonts.googleapis.com/css2?family=JetBrains Mono:wght@700');
      @import url('https://fonts.googleapis.com/css2?family=JetBrains Mono:ital,wght@700');

      /* load emoji font */
      @font-face {
        font-family: "Noto Color Emoji";
        src: url('../../assets/fonts/emoji/NotoColorEmoji-Regular.ttf');
        font-weight: 400;
      }
  
      :root {
        /* colors */
        --primary: #05b2dc;
        --secondary: #ef9B0f;
        --tertiary: #ef3e36;
        /* shades */
        --base: #ffffff;
        --mantle: #f5f4f5;
        --crust: #d4d2d5;
        --overlay: #aBaBaE;
        --footer: #000000cc;
        /* text */
        --text: #343233;
        --hltext: #ffffff;
        color: var(--text);
        /* background-specific text */
        --primary-text: var(--hltext);
        --secondary-text: var(--hltext);
        --tertiary-text: var(--hltext);
        --base-text: var(--text);
        --mantle-text: var(--text);
        --crust-text: var(--text);
        --overlay-text: var(--hltext);
        --footer-text: var(--hltext);
        /* fonts */
        --heading: Poppins, Noto Color Emoji;
        --body: Noto Sans, Noto Color Emoji;
        --mono: JetBrains Mono, Noto Color Emoji;
        font-family: var(--body); 
      }
      /* dark mode */
      @media (prefers-color-scheme: dark) {
        :root {
          /* colors */
          --primary: #05b2dc;
          --secondary: #ef9B0f;
          --tertiary: #ef3e36;
          /* shades */
          --base: #343233;
          --mantle: #373536;
          --crust: #3E3C3D;
          --overlay: #646461;
          --footer: #00000022;
          /* text */
          --text: #ffffff;
          --hltext: #343233;
          color: var(--text);
          /* background-specific text */
          --primary-text: var(--text);
          --secondary-text: var(--text);
          --tertiary-text: var(--text);
          --base-text: var(--text);
          --mantle-text: var(--text);
          --crust-text: var(--text);
          --overlay-text: var(--hltext);
          --footer-text: var(--text);
        }
      }
      /* style settings */
      header#header {
        grid-template-columns: 8rem auto 8rem;
      }
      body#background {
        background: fixed center/cover var(--base);
        
        
      }
      #background-gradient {
        background: linear-gradient(
          45deg, 
          color-mix(in srgb, var(--mantle) 80%, transparent), transparent, color-mix(in srgb, var(--crust) 20%, transparent)
        );
      }
      content#content {
        padding: 0 3rem;
        background: color-mix(in srgb, var(--base) 0%, transparent);
        border-left: none;
        border-right: none;
      }
      #avatar {
        
        border-radius: 1rem;
        
      }
      footer#footer a {
        color: #ef9B0f;
      }
      footer#footer a:hover {
        color: #ef3e36;
      }
    </style>
<link href="assets/landing-favicon.png" rel="icon" type="image/x-icon"/>
<link href="../../css/style.css" rel="stylesheet"/>
<link href="../../css/responsivity.css" rel="stylesheet"/>
<script src="../../search/main.js"></script>
<script crossorigin="anonymous" src="https://kit.fontawesome.com/b57355f8ac.js"></script>
<script id="altmetric-embed-js" src="https://d1bxh8uas1mnw7.cloudfront.net/assets/altmetric_badges-e7ba41a192efc3e63f5d48f8a1916dec4b1b49c01075bc7b39481408957b3b28.js"></script>
<link href="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed-59614f5c46b49b21eeef3bb28c4fb38d1e7069e8d014752fcb66e84942556802.css" id="altmetric-embed-css" rel="stylesheet" type="text/css"/>
</head>
<body id="background">
<div id="background-gradient"></div>
<content id="content">
<header id="article-header">
<a href="../.." id="return-home">
<i alt="⇦" class="fa fa-arrow-left"></i> Home
    </a>
<h1 id="title">ARR-1: Ave Media</h1>
</header>
<main id="page">
<nav class="vertical" id="toc">
<ul>
<li class="nav-item">
<a href="#arr-1-ave-media">ARR-1: Ave Media</a>
<ul>
<li class="nav-subitem">
<a href="#general">General</a>
</li>
<li class="nav-subitem">
<a href="#code">Code</a>
</li>
<li class="nav-subitem">
<a href="#entities-media-platforms">Entities -- Media Platforms</a>
</li>
<li class="nav-subitem">
<a href="#flow-diagram">Flow Diagram</a>
</li>
<li class="nav-subitem">
<a href="#history">History</a>
</li>
</ul>
</li>
</ul>
</nav>
<h1 id="arr-1-ave-media">ARR-1: Ave Media</h1>
<h2 id="general">General</h2>
<p>Ave Media is an application for collecting new items from various media platforms.</p>
<p>Process is initialized for each platform separately, which allows to run updates concurrently.</p>
<h2 id="code">Code</h2>
<p>Modules involved:</p>
<ul>
<li><code>bases/w/media</code></li>
<li><code>bases/w/database</code></li>
<li><code>bases/w/config</code></li>
<li><code>components/w/ave_media</code></li>
</ul>
<p>Source-specific implementations are located at <code>bases/w/media/platforms</code>. File <code>platform_service</code> contains base classes <code>MediaPlatform</code> and <code>MediaTarget</code>, which are parents to platform-specific implementations in correspondingly named files in the same directory.</p>
<h2 id="entities-media-platforms">Entities -- Media Platforms</h2>
<table>
<thead>
<tr>
<th>Platform</th>
<th>URL</th>
<th>Status</th>
<th>Targets table</th>
<th>Episodes table</th>
<th>Other tables</th>
</tr>
</thead>
<tbody>
<tr>
<td>Youtube</td>
<td><a href="https://www.youtube.com/">youtube.com</a></td>
<td>Active</td>
<td><code>youtube_channels</code></td>
<td><code>youtube_vids</code></td>
<td></td>
</tr>
<tr>
<td>Smotrim.ru</td>
<td><a href="https://smotrim.ru">smotrim.ru</a></td>
<td>Active</td>
<td><code>smotrim_brands</code></td>
<td><code>smotrim_episodes</code></td>
<td></td>
</tr>
<tr>
<td>Rutube</td>
<td><a href="https://rutube.ru">rutube.ru</a></td>
<td>Active</td>
<td><code>rutube_channels</code></td>
<td><code>rutube_episodes</code></td>
<td></td>
</tr>
<tr>
<td>Soundstream</td>
<td><a href="https://soundstream.media/">soundstream.media</a></td>
<td>In development</td>
<td><code>soundstream_channels</code></td>
<td><code>soundstream_episodes</code></td>
<td><code>soundstream_playlists</code></td>
</tr>
<tr>
<td>VK</td>
<td><a href="https://vk.com">vk.com</a></td>
<td>To be added</td>
<td>TBD</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Komsomolka</td>
<td><a href="https://radiokp.ru/">radiokp.ru</a></td>
<td>To be refactored</td>
<td>TBD</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Dentv</td>
<td><a href="https://dentv.ru">dentv.ru</a></td>
<td>To be refactored</td>
<td>TBD</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Ntv</td>
<td><a href="https://www.ntv.ru">ntv.ru</a></td>
<td>To be refactored</td>
<td>TBD</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="flow-diagram">Flow Diagram</h2>
<div class="mermaid">flowchart TD
    quit_on_resolve(Quit)
    is_target_resolved(Is target resolved?)

    subgraph collect_targets [Collect and init targets]
    direction TB
        fetch_channels(Fetch target-level entities from DB)
        fetch_channels -- for each --&gt; init_target
    end

    subgraph init_target [Init target]
    direction TB
        assign_session2(Assign DB session)
        assign_channel(Assign target-level entity)
        set_unresolved(Set target as unresolved)
        fetch_latest(Fetch target's latest episode)
        set_empty(Set target for collecting all available updates\nfetch_all = True)

        assign_session2 --- assign_channel -- if `title` is missing --&gt; set_unresolved
        assign_channel --&gt; fetch_latest -- if no latest item found --&gt; set_empty
    end

    subgraph init_platform [Init platform]
    direction LR
        assign_session1(Assign DB session)
        assign_platform_specific(Assing platform-specific attributes)

        assign_session1 --- assign_platform_specific --- collect_targets
        assign_platform_specific -- if YouTube --&gt; ytb(Youtube API client)
    end

    subgraph resolve_target [Resolve target]
    direction TB
        query_platform(Fetch target data from the platform)
        update_target_db(Update DB record)
        mark_resolved(Mark target as resolved)
        mark_dead(Mark target as defunct)

        query_platform -- if found --&gt; mark_resolved --&gt; update_target_db
        query_platform -- if not found --&gt; mark_dead
    end

    subgraph fetch_ytb_updates [ ]
    direction TB
        ytb_get_playlist_vids(Use 'get_playlist_videos' method)
        ytb_limit_none(with limit = None)
        ytb_limit_100(with limit = 100)
        ytb_get_vids(Use 'videos' method for additional data)
        ytb_check_record_exists(Query DB to check if this record exists)
        ytb_add_to_updates(Add to final list)
        ytb_parse_vids(Parse all collected videos)
        ytb_persist_vids(Save videos to the database)

        ytb_get_playlist_vids -- if fetch_all --&gt; ytb_limit_none --&gt; ytb_get_vids
        ytb_get_playlist_vids -- if only update --&gt; ytb_limit_100 --&gt; ytb_get_vids

        ytb_get_vids -- for each vid --&gt; ytb_check_record_exists -- if not --&gt; ytb_add_to_updates --&gt; ytb_parse_vids --&gt; ytb_persist_vids
    end

    subgraph fetch_smotrim_updates [ ]
    direction TB
        sm_set_params(Define params of update)
        sm_fetch_all(with pages = 10)
        sm_update(with pages = 2)
        sm_fetch_audio_updates(Fetch audio updates)
        sm_fetch_video_updates(Fetch video updates)
        sm_parse_audio_updates(Parse audio updates)
        sm_parse_video_updates(Parse video updates)
        sm_deduplicate(Remove internal duplicates)
        sm_check_exists(Check if record already exists in DB)
        sm_combine_updates(Add to final list)
        sm_persist(Save updates to the database)
        sm_temp( )

        sm_set_params -- if fetch_all --&gt; sm_fetch_all --&gt; sm_temp
        sm_set_params -- if update --&gt; sm_update --&gt; sm_temp

        sm_temp -- podcast &amp; brand --&gt; sm_fetch_audio_updates --&gt; sm_parse_audio_updates --&gt; sm_deduplicate
        sm_temp -- brand --&gt; sm_fetch_video_updates --&gt; sm_parse_video_updates --&gt; sm_deduplicate

        sm_deduplicate -- for each record --&gt; sm_check_exists -- if not --&gt; sm_combine_updates -- if any updates collected --&gt; sm_persist
    end

    subgraph fetch_rutube_updates [ ]
    direction TB
        rtb_set_params1(Set basic params)
        rtb_fetch_all(with pages = 1000)
        rtb_fetch_new(with pages = 2)
        rtb_set_params2(Set page params)
        rtb_fetch_updates(Fetch updates)
        rtb_parse_updates(Parse updates)
        rtb_deduplicate(Remove internal duplicates)
        rtb_check_exists(Check if record already exists in DB)
        rtb_persist(Save updates to the database)

        rtb_set_params1 -- if fetch_all --&gt; rtb_fetch_all --&gt; rtb_set_params2
        rtb_set_params1 -- if update --&gt; rtb_fetch_new --&gt; rtb_set_params2
        rtb_set_params2 --&gt; rtb_fetch_updates --&gt; rtb_parse_updates --&gt; rtb_deduplicate -- for each record --&gt; rtb_check_exists -- if not --&gt; rtb_persist
    end

    subgraph update_target [ ]
    direction TB
        fetch_target_updates(Collect target's updates)

        is_target_resolved -- no --&gt; resolve_target -- if resolved --&gt; fetch_target_updates -- YouTube --&gt; fetch_ytb_updates
        mark_dead --&gt; quit_on_resolve
        is_target_resolved -- yes --&gt; fetch_target_updates -- Smotrim --&gt; fetch_smotrim_updates
        fetch_target_updates -- Rutube --&gt; fetch_rutube_updates
    end

    init_platform -- for each target --&gt; update_target

</div>
<h2 id="history">History</h2>
<p>:::warning
<nothing>Nothing</nothing>
:::</p>
<nav id="page-controls">
<a href="#content" id="return-top">
<i alt="⇧" class="fa fa-arrow-up"></i> Return to top
      </a>
</nav>
</main>
</content>
<footer id="footer">
<p>Compiled from markdown using <a href="https://www.mkdocs.org/">MkDocs</a>. Theme is <a href="https://teparsons.github.io/mkdocs-landing/">Landing</a> by <a href="https://toddparsons.co.uk">Todd Parsons</a>.</p>
<script src="../../search/main.js"></script>
</footer>
<script type="module">import mermaid from "https://unpkg.com/mermaid@11.4.0/dist/mermaid.esm.min.mjs";
mermaid.initialize({});</script></body>
</html>