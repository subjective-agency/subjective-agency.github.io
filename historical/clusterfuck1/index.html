<!DOCTYPE html>
<html>

<head>
    <title>The 221223 Clusterfuck Postmortem - Wapaganda Project Docs</title>
    <style>
      /* load heading font */
      @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400');
      @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@400');
      @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@700');
      @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@700');

      /* load body font */
      @import url('https://fonts.googleapis.com/css2?family=Noto Sans:wght@400');
      @import url('https://fonts.googleapis.com/css2?family=Noto Sans:ital,wght@400');
      @import url('https://fonts.googleapis.com/css2?family=Noto Sans:wght@700');
      @import url('https://fonts.googleapis.com/css2?family=Noto Sans:ital,wght@700');

      /* load mono font */
      @import url('https://fonts.googleapis.com/css2?family=JetBrains Mono:wght@400');
      @import url('https://fonts.googleapis.com/css2?family=JetBrains Mono:ital,wght@400');
      @import url('https://fonts.googleapis.com/css2?family=JetBrains Mono:wght@700');
      @import url('https://fonts.googleapis.com/css2?family=JetBrains Mono:ital,wght@700');

      /* load emoji font */
      @font-face {
        font-family: "Noto Color Emoji";
        src: url('../../assets/fonts/emoji/NotoColorEmoji-Regular.ttf');
        font-weight: 400;
      }
  
      :root {
        /* colors */
        --primary: #05b2dc;
        --secondary: #ef9B0f;
        --tertiary: #ef3e36;
        /* shades */
        --base: #ffffff;
        --mantle: #f5f4f5;
        --crust: #d4d2d5;
        --overlay: #aBaBaE;
        --footer: #000000cc;
        /* text */
        --text: #343233;
        --hltext: #ffffff;
        color: var(--text);
        /* background-specific text */
        --primary-text: var(--hltext);
        --secondary-text: var(--hltext);
        --tertiary-text: var(--hltext);
        --base-text: var(--text);
        --mantle-text: var(--text);
        --crust-text: var(--text);
        --overlay-text: var(--hltext);
        --footer-text: var(--hltext);
        /* fonts */
        --heading: Poppins, Noto Color Emoji;
        --body: Noto Sans, Noto Color Emoji;
        --mono: JetBrains Mono, Noto Color Emoji;
        font-family: var(--body); 
      }
      /* dark mode */
      @media (prefers-color-scheme: dark) {
        :root {
          /* colors */
          --primary: #05b2dc;
          --secondary: #ef9B0f;
          --tertiary: #ef3e36;
          /* shades */
          --base: #343233;
          --mantle: #373536;
          --crust: #3E3C3D;
          --overlay: #646461;
          --footer: #00000022;
          /* text */
          --text: #ffffff;
          --hltext: #343233;
          color: var(--text);
          /* background-specific text */
          --primary-text: var(--text);
          --secondary-text: var(--text);
          --tertiary-text: var(--text);
          --base-text: var(--text);
          --mantle-text: var(--text);
          --crust-text: var(--text);
          --overlay-text: var(--hltext);
          --footer-text: var(--text);
        }
      }
      /* style settings */
      header#header {
        grid-template-columns: 8rem auto 8rem;
      }
      body#background {
        background: fixed center/cover var(--base);
        
        
      }
      #background-gradient {
        background: linear-gradient(
          45deg, 
          color-mix(in srgb, var(--mantle) 80%, transparent), transparent, color-mix(in srgb, var(--crust) 20%, transparent)
        );
      }
      content#content {
        padding: 0 3rem;
        background: color-mix(in srgb, var(--base) 0%, transparent);
        border-left: none;
        border-right: none;
      }
      #avatar {
        
        border-radius: 1rem;
        
      }
      footer#footer a {
        color: #ef9B0f;
      }
      footer#footer a:hover {
        color: #ef3e36;
      }
    </style>
    <link rel="icon" type="image/x-icon" href=assets/landing-favicon.png>
    <link href="../../css/style.css" rel="stylesheet">
    <link href="../../css/responsivity.css" rel="stylesheet">  
    <script src="../../search/main.js"></script>
    <script src="https://kit.fontawesome.com/b57355f8ac.js" crossorigin="anonymous"></script>
    <script id="altmetric-embed-js" src="https://d1bxh8uas1mnw7.cloudfront.net/assets/altmetric_badges-e7ba41a192efc3e63f5d48f8a1916dec4b1b49c01075bc7b39481408957b3b28.js"></script>
    <link id="altmetric-embed-css" rel="stylesheet" type="text/css" href="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed-59614f5c46b49b21eeef3bb28c4fb38d1e7069e8d014752fcb66e84942556802.css">
  </head>

<body id="background">
  <div id="background-gradient"></div>
  <content id="content">
  
  <header id="article-header">
    <a href=../.. id="return-home">
        <i class="fa fa-arrow-left" alt="⇦"></i> Home
    </a>
    <h1 id="title">The 221223 Clusterfuck Postmortem</h1>
</header>
  
  <main id="page">
    <nav class="vertical" id="toc">

<ul>

<li class="nav-item">
<a href="#context">Context</a>
    
    <ul>
    
    </ul>
    
</li>

<li class="nav-item">
<a href="#event">Event</a>
    
    <ul>
    
    </ul>
    
</li>

<li class="nav-item">
<a href="#damage-control-discoveries">Damage Control &amp; Discoveries</a>
    
    <ul>
    
    </ul>
    
</li>

<li class="nav-item">
<a href="#conclusions-and-updates">Conclusions and Updates</a>
    
    <ul>
    
    </ul>
    
</li>

</ul>

</nav>
    <p>On Friday, December 22, 2023 files from the data folder of the production database got removed due to negligence on the part of the project's owner.</p>
<h2 id="context">Context</h2>
<p>On Monday, December 18, 2023 I started a major refactoring work on the database (TODO: some references). The day before, on Dec 17, 2023, a backup of data was created by @atatatko on my request. The refactoring progressed quite well, although not without bumps and obstacles. Part of refactoring involved updates to the largest table we have, <code>telegram_messages</code>, in particular - fixing an error with missing subtype, and optimizing <code>content</code> field by dropping unnecessary data. Since the latter operation had to be performed on every record in the table, and the process was taking rather long due to its size, a function was developed to perform the necessary processing with PL\Python and then scheduled to run every 30 seconds, multiple times.</p>
<h2 id="event">Event</h2>
<p>At a certain point, I had 100 of these crawlers updating <code>telegram_messages</code>. Then, in a moment of madness, I decided that the type of field for <code>telegram_channel_id</code> just has to be <code>bigint</code> instead of some measly <code>integer</code>. Launching this update led to a deadlock and inevitable corruption of the index associated with the <code>content</code> field, and to the database going unresponsive.</p>
<p>I tried restarting the service, but discovered that the main drive is all out of space, which was not normal, given the size of the database at the time at around 45Gb (the drive is \~150Gb). I lockated the directory that occupied the most space; it was Postgres' data directory. In the second moment of madness, I removed everything from it indiscriminately.</p>
<p>This went down at about 16:00 Kyiv time.</p>
<h2 id="damage-control-discoveries">Damage Control &amp; Discoveries</h2>
<p>The data was removed in a particularly nasty way, as it not only led to the loss of data, but made the database unaccessible via regular means. It was still possible to connect to it directly with <code>sudo -u postgres psql</code> This is how I discovered that only <code>wapadb</code> database was killed, while the secondary databases ( <code>logs</code>, <code>windmill</code>) were pretty much intact. I exported data from all their tables from within <code>psql</code>. </p>
<p>Attempt to recover the deleted files with Linux utility <code>testdisk</code> &gt; <code>photorec</code> did produce some files, but nothing that looks like db data fiiles.</p>
<p>Then I saw no other choice but to set up instance from scratch. This involved installing Postgres anew and restoring 1) schema; 2) data.</p>
<p>Version 16 of the database was installed instead of v15, because why not.</p>
<p>For database schema, we had a dump dated October 31, 2023. Using the fact that Pycharm still had the db metadata saved locally, I manually updated the dump with current definitions. Then I took multiple attempts on running the migration, fixing errors (with missing schema qualification, tables placed in the wrong place, etc.) along the way, until I finally got it right. Some missing pieces were restored from project files and documentation afterwards.</p>
<p>The data backup, which was supposed to have been made on December 17, was missing some tables ( <code>dentv_episodes</code>), and for others, the most recent records were dated Nov 3, 2023. Data from the backup was restored without much issue, however due to the gap between most recent records and the clusterfuck event, restoration of data from local files (such as <code>.srt</code> files produced by <code>transfactory</code>) and/or updating tables via regular means, apparently, led to some mixups (specifically noticed on <code>smotrim_episodes</code>). The cause of mixup is unclear.</p>
<p>By EOD Saturday, December 23, access to the database was restored, most of the crucial data was restored, and web application was back online.</p>
<h2 id="conclusions-and-updates">Conclusions and Updates</h2>
<ol>
<li>Instead of <code>logs</code> database, <code>meta</code> database was created to hold logs, provenance records and other similar stuff.</li>
<li>Backup procedure must be established in the nearest future to avoid data loss / mixup.</li>
<li>Id field on <code>provenance</code> table is now <code>bigint</code>, not <code>uid</code>.</li>
<li>Lost data:</li>
<li><code>public.dentv_episodes</code></li>
<li><code>service.prabyss</code></li>
<li><code>service.factory_jobs_run_details</code></li>
<li><code>service.provenance</code></li>
<li><code>future</code> ?</li>
<li>TBD</li>
</ol>
    <nav id="page-controls">
      <a href="#content" id="return-top">
        <i class="fa fa-arrow-up" alt="⇧"></i> Return to top
      </a>
    </nav>
  </main>
  </content>
  <footer id="footer">
    

<p>Compiled from markdown using <a href="https://www.mkdocs.org/">MkDocs</a>. Theme is <a href="https://teparsons.github.io/mkdocs-landing/">Landing</a> by <a href="https://toddparsons.co.uk">Todd Parsons</a>.</p>














<script src="../../search/main.js"></script>

  </footer>
</body>

</html>